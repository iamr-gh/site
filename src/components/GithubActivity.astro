---
// GithubActivity.astro - Component to display recent GitHub activity
---

<div id="github-activity" class="space-y-4">
  <h2 class="text-lg font-light tracking-tight text-foreground">Currently Working On</h2>
  
  <!-- Loading state -->
  <div id="github-loading" class="space-y-3">
    <div class="animate-pulse">
      <div class="h-4 bg-muted rounded w-3/4 mb-2"></div>
      <div class="h-3 bg-muted rounded w-1/2"></div>
    </div>
    <div class="animate-pulse">
      <div class="h-4 bg-muted rounded w-2/3 mb-2"></div>
      <div class="h-3 bg-muted rounded w-1/3"></div>
    </div>
  </div>
  
  <!-- Content will be inserted here -->
  <div id="github-content" class="space-y-3 hidden">
    <!-- Repository items will be inserted here -->
  </div>
  
  <!-- Error state -->
  <div id="github-error" class="hidden text-sm text-muted-foreground">
    Unable to load GitHub activity
  </div>
</div>

<script>
  async function fetchGitHubActivity() {
    const loadingEl = document.getElementById('github-loading');
    const contentEl = document.getElementById('github-content');
    const errorEl = document.getElementById('github-error');
    
    try {
      const response = await fetch('https://api.github.com/users/iamr-gh/events?per_page=30');
      
      if (!response.ok) {
        throw new Error('Failed to fetch GitHub data');
      }
      
      const events = await response.json();
      
      // Filter for push events and get unique repositories
      const pushEvents = events.filter(event => event.type === 'PushEvent');
      const uniqueRepos = new Map();
      
      pushEvents.forEach(event => {
        const repoName = event.repo.name;
        if (!uniqueRepos.has(repoName)) {
          uniqueRepos.set(repoName, {
            name: repoName,
            description: event.payload.description || '',
            url: `https://github.com/${repoName}`,
            lastPush: new Date(event.created_at)
          });
        }
      });
      
      // Get the 3 most recent repositories
      const recentRepos = Array.from(uniqueRepos.values())
        .sort((a, b) => b.lastPush - a.lastPush)
        .slice(0, 3);
      
      // Clear loading state
      loadingEl.classList.add('hidden');
      
      if (recentRepos.length === 0) {
        errorEl.textContent = 'No recent activity found';
        errorEl.classList.remove('hidden');
        return;
      }
      
      // Render repositories
      contentEl.innerHTML = recentRepos.map(repo => {
        const timeAgo = getTimeAgo(repo.lastPush);
        return `
          <div class="space-y-1">
            <a href="${repo.url}" target="_blank" rel="noopener noreferrer" 
               class="text-sm font-medium text-foreground hover:text-primary transition-colors">
              ${repo.name}
            </a>
            <p class="text-xs text-muted-foreground">
              ${repo.description || 'No description available'}
            </p>
            <p class="text-xs text-muted-foreground">
              updated ${timeAgo}
            </p>
          </div>
        `;
      }).join('');
      
      contentEl.classList.remove('hidden');
      
    } catch (error) {
      console.error('Error fetching GitHub activity:', error);
      loadingEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
    }
  }
  
  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    const intervals = {
      year: 31536000,
      month: 2592000,
      week: 604800,
      day: 86400,
      hour: 3600,
      minute: 60
    };
    
    for (const [unit, secondsInUnit] of Object.entries(intervals)) {
      const interval = Math.floor(seconds / secondsInUnit);
      
      if (interval >= 1) {
        return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
      }
    }
    
    return 'just now';
  }
  
  // Fetch activity when page loads
  document.addEventListener('DOMContentLoaded', fetchGitHubActivity);
</script>