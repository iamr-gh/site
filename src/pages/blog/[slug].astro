---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import TableOfContents from '../../components/blog/TableOfContents.astro';

// Helper functions for processing content
function extractHeadings(html: string) {
  const headings: Array<{ id: string; text: string; level: number }> = [];
  
  // Simple regex-based heading extraction for server-side
  const headingRegex = /<h([2-6])([^>]*)>(.*?)<\/h\1>/gi;
  let match;
  let index = 0;
  
  while ((match = headingRegex.exec(html)) !== null) {
    const level = parseInt(match[1]);
    const text = match[3].replace(/<[^>]*>/g, ''); // Remove HTML tags
    const id = `heading-${index}`;
    
    headings.push({ id, text, level });
    index++;
  }
  
  return headings;
}

function extractReferences(html: string) {
  // Extract author-date citations like (Smith, 2024)
  const citationRegex = /\(([^)]+)\)/g;
  const citations: string[] = [];
  let match;
  
  while ((match = citationRegex.exec(html)) !== null) {
    const citationText = match[1];
    citations.push(citationText);
  }
  
  return citations; // Would be processed further
}



export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  // Sort by publication date (newest first)
  const sortedEntries = blogEntries.sort((a: any, b: any) => 
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
  );
  
  return sortedEntries.map((entry: any, index: number) => ({
    params: { slug: entry.slug }, 
    props: { 
      entry,
      previousEntry: index > 0 ? sortedEntries[index - 1] : null,
      nextEntry: index < sortedEntries.length - 1 ? sortedEntries[index + 1] : null,
    },
  }));
}

const { entry, previousEntry, nextEntry }: { 
  entry: CollectionEntry<'blog'>, 
  previousEntry: CollectionEntry<'blog'> | null,
  nextEntry: CollectionEntry<'blog'> | null 
} = Astro.props;
const { Content } = await entry.render();

// Extract headings for TOC
const content = await entry.render();
const headings = extractHeadings(content.html);

// Extract citations from content
const references = extractReferences(content.html);
---

<Layout title={`${entry.data.title} | iamr`}>
  <Header />
  
  <!-- Reading Progress Bar -->
  <div class="reading-progress" id="reading-progress"></div>
  
  <main class="container py-8 max-w-4xl mx-auto">
    
    
    
    <!-- Table of Contents -->
    {headings.length > 3 && (
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 mb-8">
        <div class="lg:col-span-3">
          <TableOfContents headings={headings} />
        </div>
        <div class="lg:col-span-1">
          <!-- Article Content -->
          <div class="code-block-wrapper">
            <article class="prose-technical dark:prose-invert">
              <Content />
            </article>
          </div>
        </div>
      </div>
    )}
    
    <!-- Article Content for shorter posts -->
    {headings.length <= 3 && (
      <article class="prose-technical dark:prose-invert">
        <Content />
      </article>
    )}
    
    <!-- Citations Section -->
    {references && references.length > 0 && (
      <section class="references mt-8 pt-8 border-t">
        <h2 class="text-2xl font-semibold mb-4">References</h2>
        <ol class="list-decimal list-inside space-y-2">
          {references.map((ref: string) => (
            <li class="text-muted-foreground">{ref}</li>
          ))}
        </ol>
      </section>
    )}
    
    <!-- Footer with metadata -->
    <footer class="mt-12 pt-8 border-t">
      <div class="space-y-4">
        <!-- Tags -->
        {entry.data.tags && (
          <div class="flex gap-2 flex-wrap">
            {entry.data.tags.map((tag: string) => (
              <span class="inline-flex items-center px-3 py-1 bg-accent text-accent-foreground rounded-lg text-xs font-medium">
                #{tag}
              </span>
            ))}
          </div>
        )}
        
        <!-- Author/date metadata -->
        <div class="text-sm text-muted-foreground">
          <p>By {entry.data.author} on {entry.data.pubDate.toLocaleDateString()}</p>
        </div>
      </div>
    </footer>
    
    <!-- Navigation -->
    <div class="grid grid-cols-3 gap-4 mt-12 pt-8 border-t">
      <!-- Previous Post (left column) -->
      <div class="text-left">
        {previousEntry && (
          <a 
            href={`/blog/${previousEntry.slug}`}
            class="inline-flex items-center px-4 py-2 bg-accent hover:bg-accent/80 text-accent-foreground rounded-lg text-sm font-medium transition-colors max-w-xs"
          >
            <span class="mr-2">←</span>
            <div class="truncate">
              <div class="text-xs opacity-75">Previous</div>
              <div class="truncate">{previousEntry.data.title}</div>
            </div>
          </a>
        )}
      </div>
      
      <!-- Center column -->
      <div class="text-center">
        {(!previousEntry && !nextEntry) && (
          <a 
            href="/blog" 
            class="inline-flex items-center px-4 py-2 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg text-sm font-medium transition-colors"
          >
            All Posts
          </a>
        )}
        {(previousEntry || nextEntry) && (
          <a 
            href="/blog" 
            class="text-sm text-muted-foreground hover:text-foreground transition-colors"
          >
            Back to Blog
          </a>
        )}
      </div>
      
      <!-- Next Post (right column) -->
      <div class="text-right">
        {nextEntry && (
          <a 
            href={`/blog/${nextEntry.slug}`}
            class="inline-flex items-center justify-end px-4 py-2 bg-accent hover:bg-accent/80 text-accent-foreground rounded-lg text-sm font-medium transition-colors max-w-xs ml-auto"
          >
            <div class="truncate">
              <div class="text-xs opacity-75">Next</div>
              <div class="truncate">{nextEntry.data.title}</div>
            </div>
            <span class="ml-2">→</span>
          </a>
        )}
      </div>
    </div>
  </main>
</Layout>

<script>
  // Reading progress bar
  const progressBar = document.getElementById('reading-progress');
  if (progressBar) {
    window.addEventListener('scroll', () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const progress = (scrollTop / scrollHeight) * 100;
      progressBar.style.width = progress + '%';
    });
  }
</script>