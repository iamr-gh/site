---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import SearchBar from '../../components/blog/SearchBar.astro';
import PostLine from '../../components/blog/PostLine.astro';

const allPosts = await getCollection('blog');

// Extract unique tags from all posts
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))].sort();
---

<Layout title="Blog | iamr">
  <Header />
  <main class="container py-8 max-w-4xl mx-auto">
    
    <!-- Search Section -->
    <SearchBar />
    
    <!-- Tag Filter Section -->
    <div class="mb-8">
      <div class="flex items-center gap-4 flex-wrap">
        <span class="text-sm font-medium text-muted-foreground">Filter:</span>
        <div class="flex gap-2 flex-wrap" id="tag-filters">
          <!-- All button -->
          <button 
            class="tag-filter-btn active"
            data-tag=""
            class="inline-flex items-center px-3 py-1 bg-primary text-primary-foreground rounded-full text-xs font-medium hover:bg-primary/90 transition-colors"
          >
            All
          </button>
          <!-- Dynamic tags -->
          {allTags.map(tag => (
            <button 
              class="tag-filter-btn"
              data-tag={tag}
              class="inline-flex items-center px-3 py-1 bg-secondary text-secondary-foreground rounded-full text-xs font-medium hover:bg-primary hover:text-primary-foreground transition-colors"
            >
              {tag}
            </button>
          ))}
          <!-- Clear button -->
          <button 
            id="clear-tags"
            class="inline-flex items-center px-3 py-1 bg-muted text-muted-foreground rounded-full text-xs font-medium hover:bg-accent hover:text-accent-foreground transition-colors"
          >
            Clear
          </button>
        </div>
      </div>
    </div>
    
    <!-- Blog Posts List -->
    <div class="space-y-0" id="posts-list">
      {allPosts.map((post: any) => (
        <div class="post-item" data-title={post.data.title} data-description={post.data.description} data-tags={post.data.tags?.join(' ') || ''}>
          <PostLine post={post} />
        </div>
      ))}
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center py-12">
      <p class="text-muted-foreground text-lg">No blog posts found matching your search or filters.</p>
    </div>
  </main>
</Layout>

<script define:vars={{ allPosts }}>
  window.blogPosts = allPosts.map(post => ({
    slug: post.slug,
    title: post.data.title,
    description: post.data.description,
    tags: post.data.tags || [],
    pubDate: post.data.pubDate,
    author: post.data.author
  }));
</script>

<script>
  // Tag filtering logic
  document.addEventListener('DOMContentLoaded', function() {
    const tagButtons = document.querySelectorAll('.tag-filter-btn');
    const clearButton = document.getElementById('clear-tags');
    const postItems = document.querySelectorAll('.post-item');
    
    let selectedTags = new Set();
    
    function filterPosts() {
      const hasActiveTag = selectedTags.size > 0;
      
      postItems.forEach(item => {
        if (!hasActiveTag) {
          item.style.display = 'block';
          return;
        }
        
        const postTags = new Set((item.dataset.tags || '').split(' ').filter(t => t));
        const hasAllSelectedTags = [...selectedTags].every(tag => postTags.has(tag));
        
        item.style.display = hasAllSelectedTags ? 'block' : 'none';
      });
    }
    
    tagButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tag = this.dataset.tag;
        
        if (tag === '') {
          // "All" button - clear all selections
          selectedTags.clear();
          updateButtonStates();
        } else {
          // Toggle tag selection
          if (selectedTags.has(tag)) {
            selectedTags.delete(tag);
          } else {
            selectedTags.add(tag);
          }
          updateButtonStates();
        }
        
        filterPosts();
      });
    });
    
    clearButton.addEventListener('click', function() {
      selectedTags.clear();
      updateButtonStates();
      filterPosts();
    });
    
    function updateButtonStates() {
      tagButtons.forEach(button => {
        const tag = button.dataset.tag;
        const isActive = tag === '' ? selectedTags.size === 0 : selectedTags.has(tag);
        
        if (isActive) {
          button.classList.remove('bg-secondary', 'text-secondary-foreground');
          button.classList.add('bg-primary', 'text-primary-foreground');
        } else {
          button.classList.remove('bg-primary', 'text-primary-foreground');
          button.classList.add('bg-secondary', 'text-secondary-foreground');
        }
      });
    }
  });
</script>